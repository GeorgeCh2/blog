# [工作中遇到的技术问题](https://github.com/GeorgeCh2/blog/issues/13)

1. [IDEA 运行出现“找不到或无法加载主类”](#idea-运行出现找不到或无法加载主类)
2. [网络原因导致下载 docker 镜像失败](#网络原因导致下载-docker-镜像失败)
3. [promtail 无法添加监控 target（too many open files）](#promtail-无法添加监控-targettoo-many-open-files)
4. [promtail 拉不到 Pod 的日志文件](#promtail-拉不到-pod-的日志文件)
5. [nginx 刷新端口丢失](#nginx-刷新端口丢失)
6. [JVM Remote Debug 出现 connection refused](#jvm-remote-debug-出现-connection-refused)
7. [数据库连接失败](#数据库连接失败)
8. [Prometheus 部署](#prometheus-部署)
9. [kube-state-metrics 监控指标修改](#kube-state-metrics-监控指标修改)
10. [K8S DNS 更新](#k8s-dns-更新)


## IDEA 运行出现“找不到或无法加载主类”

1. 打开 `Project Structure`
2. 删除 Moudles 下该 moudle 并重新 import

## 网络原因导致下载 docker 镜像失败

因为国内复杂的网络环境，会出现一些镜像下载失败，可以使用 `docker search image` 来查找可访问的镜像仓库

## promtail 无法添加监控 target（too many open files）

```yaml
# 在宿主机执行
sudo sysctl -w fs.inotify.max_user_instances=10240
```

| [https://www.jianshu.com/p/337946a30013](https://www.jianshu.com/p/337946a30013)

宿主机重启后会被恢复为默认值，所以还需要同步修改 sysctl.conf 文件

`sudo vim /etc/sysctl.conf`

添加内容：

`fs.inotify.max_user_instances=10240`

## promtail 拉不到 Pod 的日志文件

原因：Pod 未挂载本地盘，hostpath

## nginx 刷新端口丢失

原因：

- 重定向导致端口变为 80

解决方案：

- 因为是根目录进行重定向，直接将重定向的路径配置到 `try_files` 内  
   `try_files $uri $uri/schedule /index.html;`

## JVM Remote Debug 出现 connection refused

原因：

- 调试端口绑定了回环地址（127.0.0.1），导致外部无法访问

解决方案：

- 绑定本机 ip 地址：address=172.232.1.34:5005
- 绑定所有的 IP 地址：`-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=0.0.0.0:5005`

## 数据库连接失败

- Failed to obtain JDBC Connection; nested exception is com.alibaba.druid.pool.GetConnectionTimeoutException
  - 启动参数添加 `-Ddruid.mysql.usePingMethod=false` 关闭连接检查
  - druid 设置 keep-alive
  - 连接 url 添加 useSSL=false

## Prometheus 部署

- 删除 PersistentVolumeClaim，改为使用 volumes 映射到主机 hostPath
- securityContext 策略修改，解决读取文件没有权限的问题

```
securityContext:
  runAsGroup: 0
  runAsUser: 0
```

## kube-state-metrics 监控指标修改

- kube-state-metrics metrice 修改([https://github.com/kubernetes/kube-state-metrics/blob/master/CHANGELOG.md#v200-alpha--2020-09-16](https://github.com/kubernetes/kube-state-metrics/blob/master/CHANGELOG.md#v200-alpha--2020-09-16))
  - kube_node_status_capacity{resource=”pods/cpu/...”,unit=”cores/...”}

## K8S DNS 更新

- nginx 需要配置 dns 缓存过期
